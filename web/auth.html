<!DOCTYPE html>
<title>Authentication complete</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 20px;
  }

  .status {
    font-weight: bold;
    margin-bottom: 20px;
  }

  .code-box {
    background: #f0f0f0;
    padding: 10px;
    border-radius: 4px;
    word-break: break-all;
    font-family: monospace;
    display: none;
    margin-top: 20px;
  }
</style>

<body>
  <p class="status">Authentication signal sent.</p>
  <p>Trying to communicate with the main window...</p>

  <div id="debugInfo"></div>

  <script>
    const authUrl = window.location.href;
    const debugDiv = document.getElementById('debugInfo');

    function log(msg) {
      console.log(msg);
      const p = document.createElement('p');
      p.innerText = msg;
      debugDiv.appendChild(p);
    }

    try {
      // Method 1: LocalStorage (Primary Fallback)
      log('Attempting LocalStorage...');
      localStorage.setItem('auth_code', authUrl);
      // Toggle to verify event fires if same value
      localStorage.removeItem('auth_code');
      localStorage.setItem('auth_code', authUrl);

      // Method 2: PostMessage (Standard)
      if (window.opener) {
        log('Attempting PostMessage...');
        window.opener.postMessage(authUrl, '*');
      } else {
        log('No window.opener found. Relying on LocalStorage.');
      }

      // Auto Close
      log('Closing in 1s...');
      setTimeout(() => {
        window.close();
        document.body.innerHTML += "<p>You can close this window now.</p>";
      }, 1000);

    } catch (e) {
      log('Error: ' + e);
    }
  </script>
</body>